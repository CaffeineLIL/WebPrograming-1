document.addEventListener("DOMContentLoaded", () => {
    const rows = 10; // í–‰ ê°œìˆ˜
    const cols = 10; // ì—´ ê°œìˆ˜
    const mines = 10; // ì§€ë¢° ê°œìˆ˜
    const board = []; // ê²Œì„ ë³´ë“œ ë°ì´í„°
    const gameScreen = document.querySelector(".game-screen");
    const nicknameElement = document.getElementById("nickname");
    const scoreElement = document.getElementById("score");
    const highScoreElement = document.getElementById("highScore");
    const highScoreUserElement = document.getElementById("highScoreUser");

    // ë‹‰ë„¤ì„ í‘œì‹œ (localStorage ì—°ë™)
    const loggedInUser = localStorage.getItem("loggedInUser");
    nicknameElement.textContent = loggedInUser || "Guest"; // ë‹‰ë„¤ì„ í‘œì‹œ

    // ì ìˆ˜ì™€ ìµœê³  ì ìˆ˜ ì´ˆê¸°í™”
    let score = 0;
    const localStorageKey = `${loggedInUser || 'Guest'}_highscore`;

    // ìµœê³  ì ìˆ˜ì™€ ìœ ì € í‘œì‹œ í•¨ìˆ˜
    function displayHighScore() {
        const { highScore, highScoreUser } = getHighScore();
        highScoreElement.textContent = `ìµœê³  ì ìˆ˜: ${highScore}`;
        highScoreUserElement.textContent = `ìœ ì €: ${highScoreUser}`;
    }

    // ìµœê³  ì ìˆ˜ì™€ ìœ ì € ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    function getHighScore() {
        const highScoreData = JSON.parse(localStorage.getItem(localStorageKey));
        return highScoreData ? highScoreData : { highScore: 0, highScoreUser: "Guest" };
    }

    // ê²Œì„ ì´ˆê¸°í™”
    function initializeGame() {
        gameScreen.innerHTML = ""; // ê¸°ì¡´ ê²Œì„ í™”ë©´ ì´ˆê¸°í™”

        // ë³´ë“œ ë°ì´í„° ë° ì…€ ìƒì„±
        for (let i = 0; i < rows; i++) {
            board[i] = [];
            for (let j = 0; j < cols; j++) {
                board[i][j] = { mine: false, revealed: false, flagged: false };

                // ì…€ ìƒì„±
                const cell = document.createElement("div");
                cell.classList.add("cell");
                cell.dataset.row = i;
                cell.dataset.col = j;

                // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                cell.addEventListener("click", () => revealCell(i, j));
                cell.addEventListener("contextmenu", (e) => toggleFlag(e, i, j));
                gameScreen.appendChild(cell);
            }
        }

        // ê²Œì„ ë³´ë“œ ìŠ¤íƒ€ì¼ ì ìš©
        gameScreen.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
        gameScreen.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;

        // ì§€ë¢° ë°°ì¹˜
        placeMines();
        displayHighScore(); // ì´ˆê¸° ì ìˆ˜ í‘œì‹œ
    }

    // ì§€ë¢° ë°°ì¹˜
    function placeMines() {
        let placedMines = 0;
        while (placedMines < mines) {
            const row = Math.floor(Math.random() * rows);
            const col = Math.floor(Math.random() * cols);
            if (!board[row][col].mine) {
                board[row][col].mine = true;
                placedMines++;
            }
        }
    }

    // ì…€ ê³µê°œ
    function revealCell(row, col) {
        if (board[row][col].revealed || board[row][col].flagged) return;

        const cell = getCellElement(row, col);
        board[row][col].revealed = true;

        if (board[row][col].mine) {
            cell.classList.add("mine");
            cell.textContent = "ğŸ’£";
            alert("ê²Œì„ ì˜¤ë²„!");
            // ìµœê³  ì ìˆ˜ ê°±ì‹ 
            updateHighScore();
            initializeGame(); // ê²Œì„ ì´ˆê¸°í™”
            return;
        }

        cell.classList.add("revealed");
        const mineCount = countAdjacentMines(row, col);
        if (mineCount > 0) {
            cell.textContent = mineCount;
        } else {
            revealAdjacentCells(row, col);
        }

        // ì ìˆ˜ ì¦ê°€
        score++;
        scoreElement.textContent = score; // ì ìˆ˜ í™”ë©´ ì—…ë°ì´íŠ¸
    }

    // í”Œë˜ê·¸ í† ê¸€
    function toggleFlag(e, row, col) {
        e.preventDefault();
        const cell = getCellElement(row, col);
        if (board[row][col].revealed) return;

        board[row][col].flagged = !board[row][col].flagged;
        cell.classList.toggle("flagged");
    }

    // ì¸ì ‘ ì§€ë¢° ì¹´ìš´íŠ¸
    function countAdjacentMines(row, col) {
        let count = 0;
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const newRow = row + i;
                const newCol = col + j;
                if (
                    newRow >= 0 &&
                    newRow < rows &&
                    newCol >= 0 &&
                    newCol < cols &&
                    board[newRow][newCol].mine
                ) {
                    count++;
                }
            }
        }
        return count;
    }

    // ì¸ì ‘ ì…€ ê³µê°œ
    function revealAdjacentCells(row, col) {
        for (let i = -1; i <= 1; i++) {
            for (let j = -1; j <= 1; j++) {
                const newRow = row + i;
                const newCol = col + j;
                if (
                    newRow >= 0 &&
                    newRow < rows &&
                    newCol >= 0 &&
                    newCol < cols &&
                    !board[newRow][newCol].revealed &&
                    !board[newRow][newCol].mine
                ) {
                    revealCell(newRow, newCol);
                }
            }
        }
    }

    // ì…€ ìš”ì†Œ ê°€ì ¸ì˜¤ê¸°
    function getCellElement(row, col) {
        return gameScreen.querySelector(
            `.cell[data-row='${row}'][data-col='${col}']`
        );
    }

    // ìµœê³  ì ìˆ˜ ê°±ì‹ 
    function updateHighScore() {
        const currentHighScore = getHighScore();
        if (score > currentHighScore.highScore) {
            const highScoreData = {
                highScore: score,
                highScoreUser: loggedInUser || "Guest"
            };
            localStorage.setItem(localStorageKey, JSON.stringify(highScoreData)); // ìµœê³  ì ìˆ˜ì™€ ìœ ì € ì´ë¦„ ì €ì¥
        }
    }

    // ì´ˆê¸°í™” ì‹¤í–‰
    initializeGame();
});
